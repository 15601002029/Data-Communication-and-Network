---
tags:
  - 笔记
  - 计算机网络
  - 考研
---
# 概述
- 只有主机才有的层次：为应用层提供通信服务，使用网络层的服务。
- 功能：
	- 传输层提供进程和进程之间的逻辑通信
	- 复用和分用
	- 对收到的报文进行差错检错
## 传输层的两个协议
- TCP协议（面向连接的传输控制协议）和UDP协议（无连接的用户数据报协议）
## 传输层的寻址与端口
- 复用：应用层所有的应用进程都可以通过传输层再传输到网络层。
- 分用：传输层从网络层收到数据后交付指明的应用进程。
- 逻辑端口/软件端口：端口是传输层的SAP，标识主机中的应用进程。
	- 端口号只有本地意义，在因特网中不同计算机的相同端口没有联系
	- 端口号程度为16bit，能标识6553个不同的端口号
	- 服务端口号
		- 21 FTP
		- 23 TELNET
		- 25 SMTP
		- 53 DNS
		- 69 TFTP
		- 80 HTTP
		- 161 SNMP
	- 客户端端口号
- 在网络中采用套接字唯一标识因特网中一台计算机上的一个进程：IP地址+端口号
# UDP协议
- UDP只在IP数据报服务之上增加了很少功能，即复用分用和差错检测功能。
- 主要特点：
	- UDP是无连接的，减少开销和发送数据之前的时延。
	- UDP使用最大努力交付，即**不保证可靠交付**。
	- UDP是面向报文的，适合一次性传输少量数据的网络应用。
	- UDP无拥塞控制，适合很多实时应用。
	- UDP首部开销小，8B，TCP20B
- 
## UDP首部格式
### 格式-首部字段-共8B
- 16位源端口号
	- 希望对方收到后回复，就写上
- 16位目的端口号
- 16位UDP长度
	- UDP用户数据报的整个长度，首部+数据字段，单位为字节
- 16位UDP检验和
	- 检测整个UDP数据报是否有错，错就丢弃
## UDP校验
![[Pasted image 20241108162318.png]]
- 伪首部总长12个字节
- 伪首部只在计算校验和时才出现，不向下传递也不向上递交。
- 17：封装UDP报文的IP数据报首部协议字段是17.
- UDP长度：UDP首部8B+数据部分长度（不包括伪首部）
![[Pasted image 20241108164040.png]]
- 图为校验和时的数据报
- 在发送端
	- 填上伪首部
	- 全零填充校验字段
	- 全零填充数据部分（UDP数据报要看成许多4B的 字串连接起来）
	- 伪首部+首部+苏剧部分采用二进制反码求和
	- 去掉伪首部，发送
![[1731055327230.png]]
- 在接收端
- 填上伪首部（此时校验和字段不为0）
- 伪首部+首部+数据部分采用二进制反码求和
- 结果全为1则无差错，否则丢弃数据报/交给应用层附上出错报告
# TCP协议
## TCP协议的特点
- TCP是面向连接（虚连接）的传输层协议
- 每一条TCP连接只能有两个端点，每一条TCP连接只能是点对点的。
- TCP提供可靠交付服务，无差错、不丢失、按序到达。==可靠有序、不丢不重==
- TCP提供全双工通信，发送方具有发送缓存，准备发送的数据和已发送但尚未收到确认的数据。接收方同样具有接收缓存，按序到达但尚未被接收应用程序读取的数据和不按序到达的数据。
- TCP面向字节流：TCP把应用程序交下来的数据看成仅仅是一串**无结构的字节流**。
## **TCP报文段首部格式**
![[Pasted image 20241110134404.png]]
- 源端口/目的端口：16位，2字节，两个加起来一共四字节
- 序号：在一个TCP连接中传送的字节流中的每一个字节都按顺序编号，本字段表示**报文段所发送的数据的第一个字节的序号**。
- 确认号：期望收到对方下一个报文段的第一个数据字节的序号，若确认号为N，则证明到序号N-1为止所有的数据都已经正确收到。
- 数据偏移（首部长度）：TCP报文段的数据起始处距离TCP报文段的起始处有多长，**单位为4B**。实际表示的是TCP报文段的首部有多长。（和IP数据报的作用类似）
- 六个控制位
	- **紧急位**：URG=1时，表明此段报文段中有紧急数据，是高优先级的数据，应尽快传送，不用再缓存里排队，配合紧急指针字段使用。
	- **确认位**：ACK=1时确认号有效，再连接建立后所有传送的报文段都必须把ACK置为1。
	- 推送位：PSH=1时，接受方尽快交付接收应用进程，不在等到缓存填满缓存再向上交付。
	- 复位：RST=1时，表明TCP连接中出现严重差错，必须释放连接，然后再重新建立传输连接。
	- **同步位**：SYN=1时，表明是一个连接请求/连接接收报文。
	- **终止位**：FIN=1时，表明此报文段发送方数据已发完，要求释放连接。
- 窗口：指的是发送本报文段的一方的接收窗口，即现在允许对方发送的数据量。
- 检验和：检验首部+数据，检验时要加上12B的伪首部，第四个地段为6（表示TCP协议）
- 紧急指针：URG=1时才有意义，指出本报文段中紧急数据的字节数。
- 选项：最大报文段长度MSS，窗口扩大，时间戳、选择确认。。。
- 填充：填充一部分0使最后TCP首部的长度为4B的整数倍。
## TCP连接管理
- TCP连接的建立采用**客户服务器方式**。
### 连接建立-三次握手
![[Pasted image 20241110162553.png]]
- 客户端发送**连接请求报文段**，无应用层数据
	- SYN（同步位）=1，seq（序号位）随机产生
- 服务器端为该TCP连接**分配缓存和变量**，并向客户端返回**确认报文段**，允许连接，无应用层数据
	- SYN=1，ACK=1，seq=y（随机），ack=x+1
- 客户端为该TCP连接**分配缓存和变量**，并向服务器端返回确认的确认，可携带数据
	- SYN=0，ACK=1，seq=x+1，ack=y+1
### 数据传输
### 连接释放-四次握手
![[Pasted image 20241110163357.png]]
- 客户端发送**连接释放报文段**，停止发送数据，主动关闭TCP连接
	- FIN（结束位）=1，seq=u
- 服务器端回送一个确认报文段，客户到服务器端这个方向的连接就释放了——半关闭状态（服务器依然可以向客户发送数据）
	- ACK=1，seq=v（上一次报文段序号为v-1）ack=u+1
- 服务器端发完数据，就发出连接释放报文段，主动关闭TCP连接
	- FIN=1，ACK=1，seq=w（取决于在半关闭状态服务器又发送了多少数据），ack=u+1
- 客户端发送一个确认报文段，再等到时间等待计时器设置的2MSL（最长报文段寿命）后，连接彻底关闭。
	- ACK=1，seq=u+1，ack=w+1
## TCP可靠传输
- 网络层：提供最大努力交付，不可靠传输，因此网络层的上层就要肩负起可靠传输的职能
- 传输层：网络层的上层，即需完成可靠传输，由TCP协议完成
>[!note] 可靠传输概念
>可靠：保证接收方进程从缓存区读出的字节流与发送方发出的字节流使完全一样的
### TCP实现可靠传输的机制
- 校验：与UDP的伪首部一样
- 序号
- 确认：发送确认报文/捎带确认，发送的确认号为n，即直至n-1号字节确认接收完毕，则发送方删除n-1号以及之前的字节。
- 重传：确认重传不分家，TCP的发送方在**规定时间内**没有收到确认就要重新发送已发送的报文段。**超时重传**
	- TCP采用自适应算法，动态改变重传时间rTTs（加权平均往返时间）
### 冗余ACK
- 每当比期望序号打是时序报文段到达时，发送一个**冗余ACK**，知名下一个期待字节的序号。
![[1731314992520.png]]
- 发送方收到了**3个对于报文段1的冗余ACK**，这意味着发送方可以确认报文段2丢失，就可以立即重传2号报文。**快速重传**
## TCP流量控制
![[1731394775951.png]]
- TCP为每一个连接都设有一个持续计时器，只要TCP连接的一方收到对方的零窗口通知，就启动持续计时器。若持续计时器设置的时间到期，就发用一个零窗口的**探测报文段**（长度为一字节）。接收方收到探测报文段时会给出现在的窗口值。若窗口值仍是零，那么发送方就重新设置持续计时器。
## TCP拥塞控制
**接收窗口**：接收方根据接收缓存设置的值，并告知发送方，反应接收方的容量。
**拥塞窗口**：发送方根据自己估算的网络拥塞程度而设置的窗口值，反应网络当前容量。
### 慢开始&拥塞避免
![[1731653025073.png]]
### 快重传&快恢复
![[1731655174479.png]]